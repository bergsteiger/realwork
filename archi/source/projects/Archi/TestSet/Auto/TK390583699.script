USES
	QuickTestsUtils.script
;

// CopyMode
CONST cmWriteOver 0 // - перезаписать поверх. 
CONST cmAppend 1 //- добавить к существующему. 
CONST cmDeleteSource 16 // - удалить исходный файл. 
CONST cmNoBakCopy 32 // - не создавать копию перезаписываемого файла. 

WordAlias "Не создавать копию перезаписываемого файла" cmNoBakCopy 

STRING FUNCTION "Получить полный путь к исполняемому файлу"
	application:ExeName >>> Result
;

STRING FUNCTION "Извлечь путь из полного пути" STRING IN aFullFileName 
	aFullFileName sysutils:ExtractFilePath >>> Result
;

STRING FUNCTION "Сформировать путь к новому каталогу" STRING IN aPath
	STRING VAR aSubDir
	script:FileName '' sysutils:ChangeFileExt sysutils:ExtractFileName >>> aSubDir 
	[ aPath aSubDir ] strings:Cat >>> Result	
;

STRING FUNCTION "Получить имя ini-файла" STRING IN aPath
	STRING VAR aFileName
	aPath '.ini' sysutils:ChangeFileExt sysutils:ExtractFileName >>> aFileName
	aFileName >>> Result	
;

STRING FUNCTION "Получить имя map-файла" STRING IN aPath
	STRING VAR aFileName
	aPath '.map' sysutils:ChangeFileExt sysutils:ExtractFileName >>> aFileName
	aFileName >>> Result	
;

STRING FUNCTION "Получить имя exe-файла" STRING IN aPath
	STRING VAR aFileName
	aPath '.exe' sysutils:ChangeFileExt sysutils:ExtractFileName >>> aFileName
	aFileName >>> Result	
;

STRING FUNCTION "Прибавить к имени ini-файла '_2.ini'" STRING IN aPath
	STRING VAR aFileName
	aPath '_2.ini' sysutils:ChangeFileExt sysutils:ExtractFileName >>> aFileName
	aFileName >>> Result	
;

PROCEDURE "Создать каталог, если он не существует" STRING IN aNameDir 
	aNameDir sysutils:ForceDirectories ASSERT
;

PROCEDURE "Очистить каталог" STRING IN aPath
	aPath PureDir
;

PROCEDURE "Копировать файл" INTEGER IN aCopyMode STRING IN aDestFile STRING IN aSourceFile
	aCopyMode aDestFile aSourceFile CopyFile
;

PROCEDURE "Копировать в каталог для теста ArchiTest.ini и переименовать его" STRING IN aPath STRING IN aPathOldIni STRING IN aPathNewIni  
	STRING VAR aIniFileOld
	STRING VAR aIniFileNew
	"Получить имя ini-файла {(aPath)}" >>> aIniFileOld
	"Прибавить к имени ini-файла '_2.ini' {(aPath)}" >>> aIniFileNew	
	[ aPathOldIni aIniFileOld ] strings:Cat >>> aIniFileOld
	[ aPathNewIni '\' aIniFileNew ] strings:Cat >>> aIniFileNew
	"Копировать файл {("Не создавать копию перезаписываемого файла")} {(aIniFileNew)} {(aIniFileOld)}"
;

//
PROCEDURE "Копировать в каталог для теста ArchiTest.ini" STRING IN aPath STRING IN aPathOldIni STRING IN aPathNewIni  
	STRING VAR aIniFileOld
	STRING VAR aIniFileNew
	"Получить имя ini-файла {(aPath)}" >>> aIniFileOld
	"Получить имя ini-файла {(aPath)}" >>> aIniFileNew	
	[ aPathOldIni aIniFileOld ] strings:Cat >>> aIniFileOld
	[ aPathNewIni '\' aIniFileNew ] strings:Cat >>> aIniFileNew
	"Копировать файл {("Не создавать копию перезаписываемого файла")} {(aIniFileNew)} {(aIniFileOld)}"
;

PROCEDURE "Копировать в каталог для теста ArchiTest.exe" STRING IN aPath STRING IN aPathOldExe STRING IN aPathNewExe
	STRING VAR aExeFileOld
	STRING VAR aExeFileNew
	"Получить имя exe-файла {(aPath)}" >>> aExeFileOld
	"Получить имя exe-файла {(aPath)}" >>> aExeFileNew
	[ aPathOldExe aExeFileOld ] strings:Cat >>> aExeFileOld
	[ aPathNewExe '\' aExeFileNew ] strings:Cat >>> aExeFileNew
	"Копировать файл {("Не создавать копию перезаписываемого файла")} {(aExeFileNew)} {(aExeFileOld)}"
;

PROCEDURE "Копировать в каталог для теста ArchiTest.map" STRING IN aPath STRING IN aPathOldMap STRING IN aPathNewMap
	STRING VAR aMapFileOld
	STRING VAR aMapFileNew
	"Получить имя map-файла {(aPath)}" >>> aMapFileOld
	"Получить имя map-файла {(aPath)}" >>> aMapFileNew
	[ aPathOldMap aMapFileOld ] strings:Cat >>> aMapFileOld
	[ aPathNewMap '\' aMapFileNew ] strings:Cat >>> aMapFileNew
	"Копировать файл {("Не создавать копию перезаписываемого файла")} {(aMapFileNew)} {(aMapFileOld)}"
;


: "Сравнить текст с эталоном"
 'ArchiTest.exe' sysutils:FileExists 'Не найден ArchiTest.exe' ASSERTS
 STRING VAR l_File
 STRING VAR l_TempFile
 STRING VAR l_CMD 
 script:FileName '.evd' sysutils:ChangeFileExt
 sysutils:ExtractFileName >>> l_File
 l_File >>> l_TempFile 
 l_TempFile '_' + >>> l_TempFile

 // l_TempFile focused:control:push pop:editor:TextToFile 

 STRING VAR l_CMDLINE
 ['ArchiTest.exe TestSet\' l_TempFile ' TestSet\' l_File ' -a'] strings:Cat >>> l_CMDLINE
 l_CMDLINE WinExec
 2000 SLEEP // Чтобы предыдущаяя программа могла спокойно выполниться !
 [ 'TestSet\' l_TempFile ] strings:Cat >>> l_TempFile

 STRING VAR l_ErrorMsg  
 [ 'Не удалось удалить временный файл.' l_TempFile ] strings:Cat >>> l_ErrorMsg
 l_TempFile DeleteFile l_ErrorMsg ASSERTS

 // l_File '%' tests:CheckEtalon
;

Тест TK390583699
	Параметры: ( 
		"Не открывать документ" 
	)
	Выполнить ( 
		STRING VAR aFullPath
		STRING VAR aShortPath
		STRING VAR aSubDirForTest
		"Получить полный путь к исполняемому файлу" >>> aFullPath
		"Извлечь путь из полного пути {(aFullPath)}" >>> aShortPath
		"Сформировать путь к новому каталогу {(aShortPath)}" >>> aSubDirForTest
		"Создать каталог, если он не существует {(aSubDirForTest)}"
		"Очистить каталог {(aSubDirForTest)}"
		"Копировать в каталог для теста ArchiTest.ini и переименовать его {(aFullPath)} {(aShortPath)} {(aSubDirForTest)}"
		"Копировать в каталог для теста ArchiTest.ini {(aFullPath)} {(aShortPath)} {(aSubDirForTest)}"
		"Копировать в каталог для теста ArchiTest.exe {(aFullPath)} {(aShortPath)} {(aSubDirForTest)}"
		"Копировать в каталог для теста ArchiTest.map {(aFullPath)} {(aShortPath)} {(aSubDirForTest)}"
		// "Сравнить текст с эталоном"
	)
;

TK390583699