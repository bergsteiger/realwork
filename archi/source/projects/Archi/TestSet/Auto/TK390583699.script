// После теста нет очистки. Каталоги C:\Base\testbase2 и W:\binout\Archi\TK390583699 можно удалить вручную.
USES
	ArchiControls.script
	QuickTestsUtils.script
;

PROCEDURE "Создать каталог, если он не существует" STRING IN aNameDir
	aNameDir sysutils:ForceDirectories ASSERT
;

PROCEDURE "Подготовка к копированию" STRING IN aDestDir
	"Создать каталог, если он не существует {(aDestDir)}"
;

PROCEDURE "Копировать в каталог для теста dll" STRING IN aDestDir STRING IN aSourceDir
	 "Все dll" aDestDir aSourceDir CopyFilesByMask
;

PROCEDURE "Копировать из каталога в каталог для теста исполняемый файл" STRING IN aSourceDir STRING IN aDestDir STRING IN aFile 
	STRING VAR l_Archi_Path
	[ aSourceDir '\' aFile ] strings:Cat >>> l_Archi_Path
	STRING VAR l_DestDirArchiTest
 	[ aDestDir '\' aFile ] strings:Cat >>> l_DestDirArchiTest
	"Не создавать копию перезаписываемого файла" l_DestDirArchiTest l_Archi_Path CopyFile
;

STRING FUNCTION "Путь к директории TestSet в CVS"
	'' test:ResolveInputFilePath >>> Result	
;

PROCEDURE "Копировать в каталог для теста файл" STRING IN aDestDir STRING IN aFile
	STRING VAR l_Archi_CVS_Path
	"Путь к директории TestSet в CVS" >>> l_Archi_CVS_Path
	[ l_Archi_CVS_Path 'CMD\' aFile ] strings:Cat >>> l_Archi_CVS_Path
	STRING VAR l_DestDirArchiTest
 	[ aDestDir '\' aFile ] strings:Cat >>> l_DestDirArchiTest
	"Не создавать копию перезаписываемого файла" l_DestDirArchiTest l_Archi_CVS_Path CopyFile
;

PROCEDURE "Копирование исполняемых файлов" STRING IN aDestDir STRING IN aSourceDir
	"Копировать в каталог {(aDestDir)} для теста dll {(aSourceDir)}"
	"Копировать в каталог {(aDestDir)} для теста файл {('ArchiTest.ini')}"
	"Копировать в каталог {(aDestDir)} для теста файл {('OneTest.txt')}"
	"Копировать из каталога {(aSourceDir)} в каталог {(aDestDir)} для теста исполняемый файл {('ArchiTest.map')}"
	"Копировать из каталога {(aSourceDir)} в каталог {(aDestDir)} для теста исполняемый файл {('ArchiTest.exe')}"
;

PROCEDURE "Запуск второй копии тестового Архивариуса" STRING IN aSourceDir STRING IN aDestDir
	STRING VAR l_OneTest
	[ ' -File:' aDestDir '\' 'OneTest.txt' ] strings:Cat >>>  l_OneTest
 	STRING VAR l_CMDLINE
	[ aDestDir '\' 'ArchiTest.exe ' '-toK -FakeK' l_OneTest ' /D' ] strings:Cat >>> l_CMDLINE
	l_CMDLINE WinExec
 	500 SLEEP // Чтобы предыдущаяя программа могла спокойно выполниться !
;

Тест TK390583699
	Параметры: ( 
		"Не открывать документ"
	)
	Выполнить (
		BOOLEAN VAR l_WasException
		false >>> l_WasException	
	TRY
		STRING VAR l_SourceDir
           	"Путь Архивариуса" >>> l_SourceDir
		STRING VAR l_ArchiTestSet
 		[ l_SourceDir '\' 'TestSet' ] strings:Cat >>>  l_ArchiTestSet
          	STRING VAR l_DestDir 
           	"Путь к копии Архивариуса {(l_SourceDir)}" >>> l_DestDir
		STRING VAR l_ArchiTestSetNew
 		[ l_DestDir '\' 'TestSet' ] strings:Cat >>>  l_ArchiTestSetNew
		"Подготовка к копированию {(l_DestDir)}"
		"Очистить каталог {(l_DestDir)}"
		"Подготовка к копированию {(l_ArchiTestSetNew)}"	
		"Очистить каталог {(l_ArchiTestSetNew)}"
		"Копирование исполняемых файлов {(l_DestDir)} {(l_SourceDir)}"   		
		"Очистка тестовой базы"
		500 SLEEP
		"Запуск второй копии тестового Архивариуса {(l_SourceDir)} {(l_DestDir)}"
		"Копировать из каталога {(l_DestDir)} в каталог {(l_ArchiTestSet)} для теста исполняемый файл {('ArchiTest_267330013.runned.txt')}"
		"Сравнить с эталоном текстовый файл {(l_ArchiTestSet)} {('ArchiTest_267330013.runned.txt')}"
	EXCEPT
		true >>> l_WasException
	END
	)
;

TK390583699

