USES
	ArchiControls.script
	QuickTestsUtils.script
;

PROCEDURE "Создать каталог, если он не существует" STRING IN aNameDir 
	aNameDir sysutils:ForceDirectories ASSERT
;

PROCEDURE "Очистить каталог" STRING IN aPath
	aPath PureDir
;

PROCEDURE "Копировать файл" INTEGER IN aCopyMode STRING IN aDestFile STRING IN aSourceFile
	aCopyMode aDestFile aSourceFile CopyFile
;

PROCEDURE "Копировать в каталог для теста ArchiTest.ini и переименовать его" STRING IN aPath STRING IN aPathOldIni STRING IN aPathNewIni  
	STRING VAR aIniFileOld
	STRING VAR aIniFileNew
	"Получить имя ini-файла {(aPath)}" >>> aIniFileOld
	"Прибавить к имени ini-файла '_2.ini' {(aPath)}" >>> aIniFileNew	
	[ aPathOldIni aIniFileOld ] strings:Cat >>> aIniFileOld
	[ aPathNewIni '\' aIniFileNew ] strings:Cat >>> aIniFileNew
	"Копировать файл {("Не создавать копию перезаписываемого файла")} {(aIniFileNew)} {(aIniFileOld)}"
;

PROCEDURE "Копировать в каталог для теста ArchiTest.ini" STRING IN aPath STRING IN aPathOldIni STRING IN aPathNewIni  
	STRING VAR aIniFileOld
	STRING VAR aIniFileNew
	"Получить имя ini-файла {(aPath)}" >>> aIniFileOld
	"Получить имя ini-файла {(aPath)}" >>> aIniFileNew	
	[ aPathOldIni aIniFileOld ] strings:Cat >>> aIniFileOld
	[ aPathNewIni '\' aIniFileNew ] strings:Cat >>> aIniFileNew
	"Копировать файл {("Не создавать копию перезаписываемого файла")} {(aIniFileNew)} {(aIniFileOld)}"
;

PROCEDURE "Копировать в каталог для теста ArchiTest.exe" STRING IN aPath STRING IN aPathOldExe STRING IN aPathNewExe
	STRING VAR aExeFileOld
	STRING VAR aExeFileNew
	"Получить имя exe-файла {(aPath)}" >>> aExeFileOld
	"Получить имя exe-файла {(aPath)}" >>> aExeFileNew
	[ aPathOldExe aExeFileOld ] strings:Cat >>> aExeFileOld
	[ aPathNewExe '\' aExeFileNew ] strings:Cat >>> aExeFileNew
	"Копировать файл {("Не создавать копию перезаписываемого файла")} {(aExeFileNew)} {(aExeFileOld)}"
;

PROCEDURE "Копировать в каталог для теста ArchiTest.map" STRING IN aPath STRING IN aPathOldMap STRING IN aPathNewMap
	STRING VAR aMapFileOld
	STRING VAR aMapFileNew
	"Получить имя map-файла {(aPath)}" >>> aMapFileOld
	"Получить имя map-файла {(aPath)}" >>> aMapFileNew
	[ aPathOldMap aMapFileOld ] strings:Cat >>> aMapFileOld
	[ aPathNewMap '\' aMapFileNew ] strings:Cat >>> aMapFileNew
	"Копировать файл {("Не создавать копию перезаписываемого файла")} {(aMapFileNew)} {(aMapFileOld)}"
;

PROCEDURE "Копируем библиотеки арчи"
	STRING VAR aFullPath
	STRING VAR aShortPath
	STRING VAR aSubDirForTest
	"Получить полный путь к исполняемому файлу" >>> aFullPath
	"Извлечь путь из полного пути {(aFullPath)}" >>> aShortPath
	"Сформировать путь к новому каталогу {(aShortPath)}" >>> aSubDirForTest
	"Создать каталог, если он не существует {(aSubDirForTest)}"
	"Очистить каталог {(aSubDirForTest)}"
	STRING VAR aSourceDirDll 
	"Извлечь путь из полного пути {(aFullPath)}" >>> aSourceDirDll 
	STRING VAR aDestDirDll 
	"Сформировать путь к новому каталогу {(aShortPath)}"  >>> aDestDirDll
	STRING VAR aFileMaskDll 
	'*.dll' >>> aFileMaskDll 
	aFileMaskDll aDestDirDll aSourceDirDll CopyFilesByMask
;

PROCEDURE "Очистка тестовой базы"
	"Закрыть все окна"
	ProcessMessages 
	'testbase.zip' 'C:\Base\testbase' ClearDataBase 
;

PROCEDURE "Запустить 'ArchiTest.exe'"
	'W:\binout\Archi\TK390583699\ArchiTest.exe' sysutils:FileExists 'Не найден ArchiTest.exe' ASSERTS
 	STRING VAR l_File
 	STRING VAR l_TempFile
 	STRING VAR l_CMD 
 	script:FileName '' sysutils:ChangeFileExt
 	sysutils:ExtractFileName >>> l_File
 	l_File >>> l_TempFile 
 	l_TempFile '' + >>> l_TempFile
 	STRING VAR l_CMDLINE
 	['W:\binout\Archi\TK390583699\ArchiTest.exe TestSet\' l_TempFile ' TestSet\' l_File ' -a'] strings:Cat >>> l_CMDLINE
	l_CMDLINE WinExec
 	5000 SLEEP // Чтобы предыдущаяя программа могла спокойно выполниться !
 	[ 'W:\binout\Archi\TK390583699\TestSet\' l_TempFile ] strings:Cat >>> l_TempFile
;

Тест TK390583699
	Параметры: ( 
		"Не открывать документ" 
	)
	Выполнить ( 
		STRING VAR aFullPath
		STRING VAR aShortPath
		STRING VAR aSubDirForTest
		"Получить полный путь к исполняемому файлу" >>> aFullPath
		"Извлечь путь из полного пути {(aFullPath)}" >>> aShortPath
		"Сформировать путь к новому каталогу {(aShortPath)}" >>> aSubDirForTest
		"Создать каталог, если он не существует {(aSubDirForTest)}"
		"Очистить каталог {(aSubDirForTest)}"
		"Копируем библиотеки арчи"
		"Копировать в каталог для теста ArchiTest.ini и переименовать его {(aFullPath)} {(aShortPath)} {(aSubDirForTest)}"
		"Копировать в каталог для теста ArchiTest.ini {(aFullPath)} {(aShortPath)} {(aSubDirForTest)}"
		"Копировать в каталог для теста ArchiTest.exe {(aFullPath)} {(aShortPath)} {(aSubDirForTest)}"
		"Копировать в каталог для теста ArchiTest.map {(aFullPath)} {(aShortPath)} {(aSubDirForTest)}"
		"Очистка тестовой базы"
		"Запустить 'ArchiTest.exe'"
	)
;

TK390583699