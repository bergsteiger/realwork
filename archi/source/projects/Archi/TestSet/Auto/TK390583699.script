USES
	ArchiControls.script
	QuickTestsUtils.script
;

PROCEDURE "Создать каталог, если он не существует" STRING IN aNameDir 
	aNameDir sysutils:ForceDirectories ASSERT
;

PROCEDURE "Подготовка к копированию" STRING IN aDestDir
	"Создать каталог, если он не существует {(aDestDir)}"
;

PROCEDURE "Копировать в каталог для теста dll" STRING IN aDestDir STRING IN aSourceDir
	 "Все dll" aDestDir aSourceDir CopyFilesByMask
;

PROCEDURE "Копировать из каталога в каталог для теста исполняемый файл" STRING IN aSourceDir STRING IN aDestDir STRING IN aFile 
	STRING VAR l_Archi_Path
	[ aSourceDir '\' aFile ] strings:Cat >>> l_Archi_Path
	STRING VAR l_DestDirArchiTest
 	[ aDestDir '\' aFile ] strings:Cat >>> l_DestDirArchiTest
	"Не создавать копию перезаписываемого файла" l_DestDirArchiTest l_Archi_Path CopyFile
;

STRING FUNCTION "Путь к директории TestSet в CVS"
	'' test:ResolveInputFilePath >>> Result	
;

PROCEDURE "Копировать в каталог для теста файл" STRING IN aDestDir STRING IN aFile
	STRING VAR l_Archi_CVS_Path
	"Путь к директории TestSet в CVS" >>> l_Archi_CVS_Path
	[ l_Archi_CVS_Path 'CMD\' aFile ] strings:Cat >>> l_Archi_CVS_Path
	STRING VAR l_DestDirArchiTest
 	[ aDestDir '\' aFile ] strings:Cat >>> l_DestDirArchiTest
	"Не создавать копию перезаписываемого файла" l_DestDirArchiTest l_Archi_CVS_Path CopyFile
;

PROCEDURE "Копирование исполняемых файлов" STRING IN aDestDir STRING IN aSourceDir
	"Копировать в каталог {(aDestDir)} для теста dll {(aSourceDir)}"
	"Копировать в каталог {(aDestDir)} для теста файл {('ArchiTest.ini')}"
	"Копировать в каталог {(aDestDir)} для теста файл {('OneTest.txt')}"
	"Копировать из каталога {(aSourceDir)} в каталог {(aDestDir)} для теста исполняемый файл {('ArchiTest.map')}"
	"Копировать из каталога {(aSourceDir)} в каталог {(aDestDir)} для теста исполняемый файл {('ArchiTest.exe')}"
;

PROCEDURE "Запуск второй копии тестового Архивариуса" STRING IN aSourceDir STRING IN aDestDir
	STRING VAR l_File
 	STRING VAR l_TempFile
 	STRING VAR l_CMD 
 	script:FileName '' sysutils:ChangeFileExt
 	sysutils:ExtractFileName >>> l_File
 	l_File >>> l_TempFile 
 	l_TempFile '_' + >>> l_TempFile
 	STRING VAR l_CMDLINE
 	[ "Путь к копии Архивариуса {(aSourceDir)}" >>> aDestDir 'ArchiTest.exe TestSet\' '-toK -FakeK -File:OneTest.txt' l_TempFile ' TestSet\' l_File ' -a'] strings:Cat >>> l_CMDLINE	
	l_CMDLINE WinExec
 	5000 SLEEP // Чтобы предыдущаяя программа могла спокойно выполниться !
 	[ "Путь к копии Архивариуса {(aSourceDir)}" >>> aDestDir 'TestSet\' l_TempFile ] strings:Cat >>> l_TempFile
;

Тест TK390583699
	Параметры: ( 
		"Не открывать документ" 
	)
	Выполнить (
		STRING VAR l_SourceDir
           	"Путь Архивариуса" >>> l_SourceDir
          	STRING VAR l_DestDir 
           	"Путь к копии Архивариуса {(l_SourceDir)}" >>> l_DestDir
	TRY 
		"Подготовка к копированию {(l_DestDir)}"
		"Копирование исполняемых файлов {(l_DestDir)} {(l_SourceDir)}"   		
		"Распаковка тестовой базы"
		"Запуск второй копии тестового Архивариуса {(l_SourceDir)} {(l_DestDir)}"
		"Сравнить с эталоном количество открытых окон Арчи"
	FINALLY
                "Очистка после теста"
		"Очистить каталог {(l_DestDir)}"	
	END
	)
;

TK390583699

