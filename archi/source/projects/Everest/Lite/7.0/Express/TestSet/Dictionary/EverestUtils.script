// EverestUtils.script
// Всякие обертки для Эвереста

USES
 axiom:Tests
 axiom:push
 axiom:Form
 axiom:Control
 axiom:Editor
 axiom:BeginWait
 axiom:EndWait
 axiom:Wait
 axiom:Waited
 axiom:Component
 
	ArchiSystem.script
	CommonWords.script
	EverestControls.script
;

WordAlias Создать_пустой Create
WordAlias "Новый документ" Create
WordAlias Создать Open // Арчи-совместимое открытие
WordAlias Закрыть CloseActiveWindow
WordAlias "Развернуть редактор" "Развернуть окно"
WordAlias Создать_из OpenWith

PROCEDURE "Подготовка к выравниванию линий" 
	 "Подготовить широкую главную форму"
	 "Развернуть редактор"
	 "Выключить все флаги"
;

PROCEDURE "Сохранить в NSR и сравнить с эталоном"
	csNSRExt SaveWithOtherExtention
	VAR l_File
	script:FileName csNSRExt sysutils:ChangeFileExt
	sysutils:ExtractFileName >>> l_File
	l_File ';' tests:CheckEtalon
;

PROCEDURE "Сохранить в RTF и сравнить с эталоном"
	csRTFExt SaveWithOtherExtention
	VAR l_File
	script:FileName csRTFExt sysutils:ChangeFileExt
	sysutils:ExtractFileName >>> l_File
	l_File ';' tests:CheckEtalon	
;

PROCEDURE "Сохранить в HTML и сравнить с эталоном"
	csHTMExt SaveWithOtherExtention
	VAR l_File
	script:FileName csHTMExt sysutils:ChangeFileExt
	sysutils:ExtractFileName >>> l_File
	l_File ';' tests:CheckEtalon	
;

PROCEDURE "Сохранить в PDF" 
	false GeneratePDFForEtalon
	csPDFExt SaveWithOtherExtention
;

PROCEDURE "Сохранить в PDF и сравнить с эталоном"
	true GeneratePDFForEtalon
	csPDFExt SaveWithOtherExtention
	VAR l_File
	script:FileName csPDFExt sysutils:ChangeFileExt
	sysutils:ExtractFileName >>> l_File
	l_File ';' tests:CheckEtalon	
;

PROCEDURE "Спрятать РЕЕСТР ОБЪЕКТОВ"

;

PROCEDURE "Найти таблицу"
	'acFindTable' arMainActionList push:MainForm pop:form:ExecuteAction
;

PROCEDURE "Расстановка разделов" 
	'acToolsSetSections' 'theActions' push:MainForm pop:form:ExecuteAction
;

CONST csEverest2Everest 'everest2everest.exe'

PROCEDURE "Сравнить текст с эталоном" 
 SetAppPath2CurrentDir	
 csEverest2Everest sysutils:FileExists 'Не найдена утилита everest2everest.exe' ASSERTS	
 STRING VAR l_File
 STRING VAR l_TempFile
 STRING VAR l_CMD 
 script:FileName '.evd' sysutils:ChangeFileExt
 sysutils:ExtractFileName >>> l_File
 l_File >>> l_TempFile 
 '_' l_TempFile + >>> l_TempFile
 l_TempFile focused:control:push pop:editor:TextToFile 
 STRING VAR l_CMDLINE 
 ['everest2everest.exe TestSet\' l_TempFile ' TestSet\' l_File ' -a'] strings:Cat >>> l_CMDLINE
 l_CMDLINE WinExec
 2000 SLEEP // Чтобы предыдущаяя программа могла спокойно выполниться !
 [ 'TestSet\' l_TempFile ] strings:Cat >>> l_TempFile
 STRING VAR l_ErrorMsg  
 [ 'Не удалось удалить временный файл.' l_TempFile ] strings:Cat >>> l_ErrorMsg
 l_TempFile DeleteFile l_ErrorMsg ASSERTS
 l_File '%' tests:CheckEtalon
;

PROCEDURE "Предварительный просмотр"
 'acPrintPreview' 'theActions' push:MainForm pop:form:ExecuteAction
;

PROCEDURE "Нажимаем предварительный просмотр"
 BeginWait:Print
 TRY
  "Предварительный просмотр"
  "Развернуть окно"
  "Обработать сообщения"
  WHILE ( IsPreviewInProgress ) ( "Обработать сообщения" )    
 FINALLY  
  EndWait:Print  
  Закрыть
  "Обработать сообщения"
 END 
;


PROCEDURE "Разбивка на блоки действие"
 'acBuildDocumentStructure' 'theActions' push:MainForm pop:form:ExecuteAction
;

PROCEDURE "Разбивка на блоки без диалога 'Создание структуры блоков'"
	@ ( "Разбивка на блоки действие" ) MODAL ( "Контрол по имени {('BitBtn1')}" pop:Control:Click ) 	 
;

PROCEDURE "Работа с диалогом 'Создание структуры блоков'"
  "Контрол по имени {('BitBtn1')}" pop:Control:Click
;

PROCEDURE "Разбивка на блоки"
	@ ( "Разбивка на блоки без диалога 'Создание структуры блоков'" ) MODAL ( "Работа с диалогом 'Создание структуры блоков'" ) 	 
;

PROCEDURE "Разбивка на блоки с ожиданием запроса"
  mrYesToAll wait:Choice
  TRY
    "Разбивка на блоки"
  FINALLY
   waited:? ASSERT
  END  
;

PROCEDURE "Название выбранного стиля - в стек"
	'Text' "Поле выбора стиля" push:MainForm pop:Component:FindComponent pop:object:GetStrProp .
;

PROCEDURE "Вставить блок"
	 'acInsertBlock' 'theActions' push:MainForm pop:form:ExecuteAction
;

PROCEDURE "Делать машиннозависимые эталоны"
	EtalonNeedsComputerName
;