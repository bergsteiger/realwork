//#UC START# *49521D8E0295_4AE1A69E0156exec_impl*
 l_Preview := MakePreview;
 try
  l_Preview.Print;
 finally
  l_Preview := nil;
 end;//try..finally
//#UC END# *49521D8E0295_4AE1A69E0156exec_impl*
//#UC START# *49521D8E0295_4AE1A69E0156exec_var*
var
 l_Preview: IafwComplexDocumentPreview;
//#UC END# *49521D8E0295_4AE1A69E0156exec_var*
//#UC START# *49521D8E0295_4AE1A69E0156test_impl*
 aParams.CallControl;
 if aParams.Op.Flag[vcm_ofEnabled] then
  aParams.Op.Flag[vcm_ofEnabled] := HasDoc;
 if aParams.Op.Flag[vcm_ofEnabled] then
  aParams.Op.Flag[vcm_ofEnabled] := Printer.Printers.Count > 0;
 nsDisableOperationInTrialMode(aParams);
//#UC END# *49521D8E0295_4AE1A69E0156test_impl*
//#UC START# *49521D8E0295_4AE1A69E0156test_var*
//#UC END# *49521D8E0295_4AE1A69E0156test_var*
//#UC START# *495220DE0298_4AE1A69E0156exec_impl*
 DocumentPrint(True);
//#UC END# *495220DE0298_4AE1A69E0156exec_impl*
//#UC START# *495220DE0298_4AE1A69E0156exec_var*
//#UC END# *495220DE0298_4AE1A69E0156exec_var*
//#UC START# *495220DE0298_4AE1A69E0156test_impl*
 aParams.CallControl;
 if aParams.Op.Flag[vcm_ofEnabled] then
  aParams.Op.Flag[vcm_ofEnabled] := HasDoc;
//#UC END# *495220DE0298_4AE1A69E0156test_impl*
//#UC START# *495220DE0298_4AE1A69E0156test_var*
//#UC END# *495220DE0298_4AE1A69E0156test_var*
//#UC START# *495220F2033A_4AE1A69E0156exec_impl*
 TnsDocumentPrintPreviewEvent.Log(DocumentForExport);
 aParams.CallControl;
//#UC END# *495220F2033A_4AE1A69E0156exec_impl*
//#UC START# *495220F2033A_4AE1A69E0156exec_var*
//#UC END# *495220F2033A_4AE1A69E0156exec_var*
//#UC START# *495220F2033A_4AE1A69E0156test_impl*
 aParams.CallControl;
 if aParams.Op.Flag[vcm_ofEnabled] then
  aParams.Op.Flag[vcm_ofEnabled] := HasDoc;
 if aParams.Op.Flag[vcm_ofEnabled] then
  aParams.Op.Flag[vcm_ofEnabled] := Printer.Printers.Count > 0;
//#UC END# *495220F2033A_4AE1A69E0156test_impl*
//#UC START# *495220F2033A_4AE1A69E0156test_var*
//#UC END# *495220F2033A_4AE1A69E0156test_var*
//#UC START# *495235F401C0_4AE1A69E0156exec_impl*
 DocumentExport(ekDisk, Text.HasSelection);
//#UC END# *495235F401C0_4AE1A69E0156exec_impl*
//#UC START# *495235F401C0_4AE1A69E0156exec_var*
//#UC END# *495235F401C0_4AE1A69E0156exec_var*
//#UC START# *495235F401C0_4AE1A69E0156test_impl*
 //NotEmptyDocumentWithTrialModeTest(aParams);
 NotEmptyDocumentTest(aParams);
//#UC END# *495235F401C0_4AE1A69E0156test_impl*
//#UC START# *495235F401C0_4AE1A69E0156test_var*
//#UC END# *495235F401C0_4AE1A69E0156test_var*
//#UC START# *495238EB0160_4AE1A69E0156exec_impl*
 lExportSelection := Text.HasSelection;
 // Ёкспортировать выделенные фрагменты в Word
 if (lExportSelection) then
  case MessageDlg(str_ExportSelectionToWord) of
    -1:
     // - выделение
     ;
    -2:
     lExportSelection := False;
    mrCancel:
     Exit;
  end;//case MessageDlg(str_ExportSelectionToWord)
 DocumentExport(cMap[aParams.ItemIndex>1], lExportSelection);
//#UC END# *495238EB0160_4AE1A69E0156exec_impl*
//#UC START# *495238EB0160_4AE1A69E0156exec_var*
var
 lExportSelection : Boolean;
const
 cMap: array [Boolean] of TnsExportKind = (ekShell, ekActiveWord);
//#UC END# *495238EB0160_4AE1A69E0156exec_var*
//#UC START# *495238EB0160_4AE1A69E0156test_impl*
 File_Save_Test(aParams);
 TnsToMSWordOp.Test(aParams);
//#UC END# *495238EB0160_4AE1A69E0156test_impl*
//#UC START# *495238EB0160_4AE1A69E0156test_var*
//#UC END# *495238EB0160_4AE1A69E0156test_var*
//#UC START# *495253870002_4AE1A69E0156exec_impl*
 l_ExportSelection := Text.HasSelection;
 // Ёкспортировать выделенные фрагменты в Word
 if (l_ExportSelection) then
  case MessageDlg(str_DocumentEMailSelection) of
    -1:
     ; // выделение
    -2:
     l_ExportSelection := False;
    mrCancel:
     Exit;
  end;//case MessageDlg(str_DocumentEMailSelection)
 DocumentExport(ekEMail, l_ExportSelection);
//#UC END# *495253870002_4AE1A69E0156exec_impl*
//#UC START# *495253870002_4AE1A69E0156exec_var*
var
 l_ExportSelection : Boolean;
//#UC END# *495253870002_4AE1A69E0156exec_var*
//#UC START# *495253870002_4AE1A69E0156test_impl*
 //NotEmptyDocumentWithTrialModeTest(aParams);
 NotEmptyDocumentTest(aParams);
//#UC END# *495253870002_4AE1A69E0156test_impl*
//#UC START# *495253870002_4AE1A69E0156test_var*
//#UC END# *495253870002_4AE1A69E0156test_var*
//#UC START# *4A1FF17502AC_4AE1A69E0156_impl*
 Result := false;
 l_Format := CF_LOCALE;
 if anExportKind = ekDisk then
 begin
  with dmStdRes do
  begin
   SaveDialog.FileName := l3PStr(GetDocumentExportName(DocumentForExport, aExportSelection));
   SaveDialog.DialogKind := ns_sdkDocument;
   if Text.HasSelection then
   begin
    SaveDialog.SelectedOnlyEnabled := true;
    SaveDialog.SelectedOnlyChecked := true;
   end//if Text.HasSelection then
   else
   begin
    SaveDialog.SelectedOnlyEnabled := false;
    SaveDialog.SelectedOnlyChecked := false;
   end;//if Text.HasSelection then
   if not SaveDialog.Execute then
    Exit;
   aExportSelection := SaveDialog.SelectedOnlyChecked;
   l_Output := TnsGetGenOutputStruct_Create(nsCStr(SaveDialog.FileName));
   l_F := SaveDialog.SelectedFileFormat;
   l_Ext := nsGetFileFormatExt(l_F);
   case l_F of
    ns_ffRTF :
     l_Format := CF_RTF;
    ns_ffTxt:
     l_Format := CF_TEXT;
    ns_ffHTML:
     l_Format := CF_HTML;
    ns_ffEvd:
     l_Format := CF_EverestTxt;
   end;//case SaveDialogFileFormat of
   l_Output.rName := nsCStr(ChangeFileExt(l3PStr(l_Output.rName), l_Ext));
  end;
 end
 else
 begin
  l_Output := TnsGetGenOutputStruct_Create(nsMakeTemporaryFileName(
   GetDocumentExportName(DocumentForExport, aExportSelection), '.rtf'));
  l_Format := CF_RTF;
  l_F := ns_ffRTF;
 end;//aNeedDialog
 try
  case anExportKind of
   ekShell, ekActiveWord:
    l_Visualizer := bsMakeExportVisualizer(vcmCStr(str_ExportDocumentVisualizer));
   ekDisk:
    l_Visualizer := bsMakeSaveVisualizer(vcmCStr(str_SaveDocumentVisualizer));
   ekEMail:
    l_Visualizer := bsMakeEMailVisualizer;
  else
   Assert(False);
  end;
  try
   l_Stream := Tl3NamedTextStream.Create(l3PStr(l_Output.rName), l3_fmWrite, 0);
   try
    case l_Format of
     CF_Locale :
     begin
      if nsGetGen(l_Output, l_F, l_G, l_H) then
       try
        l_G.Filer.Mode := l3_fmWrite;
        l_G.Filer.Stream := l_Stream;
        try
         nsSetExportFilters4PDF(l_H, Text.HiddenStyles);
         l_H.Start;
         try
          if aExportSelection then
          begin
           if afw.Application.Settings.LoadBoolean(pi_Document_ExportWithBlockNames, dv_Document_ExportWithBlockNames) then
           begin
            l_Head := TevdBlockNameAdder.Create;
            Ik2TagGenerator(l_Head).NextGenerator := l_H;
           end//afw.Application.Settings.LoadBoolean(pi_Document_ExportWithBlockNames, dv_Document_ExportWithBlockNames)
           else
            l_Head := l_H.Use;
           try
            l_Head.Start;
            try
             if Assigned(aRange) then
              aRange.AsStorable.Store(Text.View, l_Head)
             else
              InevSelection(Text.Selection).GetBlock.AsStorable.Store(Text.View, l_Head);
            finally
             l_Head.Finish;
            end;//try..finally
           finally
            FreeAndNil(l_Head);
           end;//try..finally
          end//aExportSelection
          else
           Text.Document.Range.AsStorable.Store(Text.View, l_H);
         finally
          l_H.Finish;
         end;//try..finally
        finally
         l_G.Filer.Stream := nil;
        end;//try..finally
       finally
        FreeAndNil(l_G);
        FreeAndNil(l_H);
       end;//try..finally
     end;//CF_Locale
     else
     begin
      if aExportSelection and Assigned(aRange) then
       aRange.Data.Store(l_Format, l_Stream, Text.MakeExportFilters(aExportSelection, true))
      else
       Text.SaveTo(l_Stream, l_Format, aExportSelection);
     end;//else
    end;//case l_F
   finally
    FreeAndNil(l_Stream);
   end;//try..finally
  finally
   l_Visualizer := nil;
  end;//try..finally
  Result := True;
  case anExportKind of
   ekDisk:
    TnsExportToFileEvent.Log(DocumentForExport);
   ekShell, ekActiveWord:
    begin
     if LowerCase(ExtractFileExt(l3PStr(l_Output.rName))) = '.rtf' then
      TnsExportToWordEvent.Log(DocumentForExport, aExportSelection, anExportKind = ekActiveWord);
     if anExportKind  = ekShell then
      Result := TnsToMSWordOp.Execute(l_Output.rName, mswekNewFile)
     else
      Result := TnsToMSWordOp.Execute(l_Output.rName, mswekActiveWindow);
    end;
   ekEMail:
    begin
     try
      Result := nsSendAttachedFile(l_Output.rName);
      TnsSendDocumentByEMailEvent.Log(DocumentForExport);
     except
      on EDefaultMailCLientAbsent do
       Say(err_DefaultMailCLientAbsent);
     end;
    end;
  else
   Assert(False);
  end;
 except
  on EStreamError do
  begin
   SysUtils.DeleteFile(l3PStr(l_Output.rName));
   Say(err_NotEnoughRoom, [ExtractFileName(l3PStr(l_Output.rName))]);
  end;//EStreamError
  on EOsError do
   Say(err_CannotCreateFile, [ExtractFileName(l3PStr(l_Output.rName))]);
  on EnevMaybeBaseSwitched do
   Say(err_ExportError, []);
 end;//try..except
//#UC END# *4A1FF17502AC_4AE1A69E0156_impl*
//#UC START# *4A1FF17502AC_4AE1A69E0156_var*
var
 l_H    : Tk2TagGenerator;
 l_Output : TnsGetGenOutputStruct;
//#UC END# *4A1FF17502AC_4AE1A69E0156_var*
//#UC START# *4A8E8F2E0195_4AE1A69E0156_impl*
 Text.TextSource := Self.TextSource;
 inherited;
 Text.OnMakeMacroReplacer := Self.MakeMacroReplacer;
 Text.OnMakeExportFilters := Self.DoMakeExportFilters;
//#UC END# *4A8E8F2E0195_4AE1A69E0156_impl*
//#UC START# *4A8E8F2E0195_4AE1A69E0156_var*
//#UC END# *4A8E8F2E0195_4AE1A69E0156_var*
//#UC START# *4AE1864F024B_4AE1A69E0156_impl*
 l_F := HAFMacroReplacerFactory;
 if (l_F <> nil) then
  aReplacer := l_F.MakeHAFMacroReplacer;
//#UC END# *4AE1864F024B_4AE1A69E0156_impl*
//#UC START# *4AE1864F024B_4AE1A69E0156_var*
var
 l_F : IucpHAFMacroReplacerFactory;
//#UC END# *4AE1864F024B_4AE1A69E0156_var*
//#UC START# *4AE1B21502BB_4AE1A69E0156_impl*
 if aPrintDialog and
    ((afw.Application = nil) or
     (afw.Application.PrintManager = nil)) then
  Exit;
 l_Preview := MakePreview;
 if (l_Preview <> nil) then
 begin
  if (l_Preview.ContentKind = afw_pckSelection) then
   case MessageDlg(str_PrintSelectedConfirmation) of
    -1:
     ;
    -2:
     l_Preview.ContentKind := afw_pckDocument;
    mrCancel:
     Exit; 
   end;//case MessageDlg(str_DocumentPrintSelectedConfirmation)
  if aPrintDialog then
   afw.Application.PrintManager.PrintDialog(l_Preview)
  else
   l_Preview.Print;
 end;//l_Preview <> nil
//#UC END# *4AE1B21502BB_4AE1A69E0156_impl*
//#UC START# *4AE1B21502BB_4AE1A69E0156_var*
//#UC END# *4AE1B21502BB_4AE1A69E0156_var*
//#UC START# *4AE1B41802E4_4AE1A69E0156_impl*
 Result := Text.Preview;
//#UC END# *4AE1B41802E4_4AE1A69E0156_impl*
//#UC START# *4AE1B41802E4_4AE1A69E0156_var*
//#UC END# *4AE1B41802E4_4AE1A69E0156_var*
//#UC START# *4AE1BA9302E5_4AE1A69E0156_impl*
 if aParams.Op.Flag[vcm_ofEnabled] then
  aParams.Op.Flag[vcm_ofEnabled] := TextSource.HasDocument;
//#UC END# *4AE1BA9302E5_4AE1A69E0156_impl*
//#UC START# *4AE1BA9302E5_4AE1A69E0156_var*
//#UC END# *4AE1BA9302E5_4AE1A69E0156_var*
//#UC START# *4AE1BAA102BD_4AE1A69E0156_impl*
 NotEmptyDocumentTest(aParams);
 nsDisableOperationInTrialMode(aParams);
//#UC END# *4AE1BAA102BD_4AE1A69E0156_impl*
//#UC START# *4AE1BAA102BD_4AE1A69E0156_var*
//#UC END# *4AE1BAA102BD_4AE1A69E0156_var*
//#UC START# *4AE1C14801CE_4AE1A69E0156_impl*
 Result := false;
 if (aPara <> nil) then
 begin
  CreateBookmark(DocumentForExport, aPara.ID, true, l_Bookmark);
  if (l_Bookmark <> nil) then
  try
   Result := 
    TdmStdRes.SaveOpen(Self.As_IvcmEntityForm,
                       FilterInfoFactory.MakeFilterInfo(ffListAndBookMarks),
                       cIsDrugDocument[IsDrug],
                       l_Bookmark,
                       false) = mrOk;
   if Result then
    PostMessage(Handle, CM_NEED_TO_OPEN_CONTENTS, 0, 0);
  finally
   l_Bookmark := nil;
  end;//try..finally
 end;//aPara <> nil 
//#UC END# *4AE1C14801CE_4AE1A69E0156_impl*
//#UC START# *4AE1C14801CE_4AE1A69E0156_var*
var
 l_Bookmark : IBookmark;

const
 cIsDrugDocument: array [Boolean] of TFoldersElementType = (
   fetBookMark,
   fetDrugBookmark
 );
 
//#UC END# *4AE1C14801CE_4AE1A69E0156_var*
//#UC START# *4DCD5DE203C5_4AE1A69E0156_impl*
 Tf1MultilinkResolver.SetTo(theGen, DocumentForExport);
//#UC END# *4DCD5DE203C5_4AE1A69E0156_impl*
//#UC START# *4DCD5DE203C5_4AE1A69E0156_var*
//#UC END# *4DCD5DE203C5_4AE1A69E0156_var*
//#UC START# *53D8D3E90248_4AE1A69E0156_impl*
 Result := GetDocumentShortName(aDoc, aExportSelection);
 if l3IsNil(Result) then
  Result := CreateFileName(aDoc, aExportSelection)
 else
  Result := CreateFileName(Result, aExportSelection);
//#UC END# *53D8D3E90248_4AE1A69E0156_impl*
//#UC START# *53D8D3E90248_4AE1A69E0156_var*
//#UC END# *53D8D3E90248_4AE1A69E0156_var*
//#UC START# *53D8E4B702E4_4AE1A69E0156_impl*
 Result := nil;
//#UC END# *53D8E4B702E4_4AE1A69E0156_impl*
//#UC START# *53D8E4B702E4_4AE1A69E0156_var*
//#UC END# *53D8E4B702E4_4AE1A69E0156_var*
