//#UC START# *479731C50290_5506DC9F019D_impl*
 FreeAndNil(f_Children);
 FreeAndNil(f_Docked);
 inherited;
//#UC END# *479731C50290_5506DC9F019D_impl*
//#UC START# *479731C50290_5506DC9F019D_var*
//#UC END# *479731C50290_5506DC9F019D_var*
//#UC START# *5506DC9F019D_ext:ParentFileName
w:\common\components\gui\Garant\VCM\implementation\vcmHistory.pas
//#UC END# *5506DC9F019D_ext:ParentFileName
//#UC START# *550811520043_5506DC9F019D_impl*
 try
  inherited Create(aForm, aStateType, aFormId, aUserType, aZoneType, aItemType, aSubUserType, aForClone);
 except
  on EvcmFormWasClosedInSave do
  // - форму закрыли в процессе сохранения
  //   Например БП из-за:
  //    http://mdp.garant.ru/pages/viewpage.action?pageId=321989072&focusedCommentId=330698655#comment-330698655
  begin
   f_Caption := aForm.MainCaption;
   FreeAndNil(f_Children);
   FreeAndNil(f_Docked);
   f_ItemType := vcm_hitClose;
  end;//on EvcmFormWasClosedInSave
 end;//try..except
 if Assigned(aForm) then
 begin
  f_Caption := aForm.MainCaption;
  FreeAndNil(f_Children);
  FreeAndNil(f_Docked);
  SaveOwned(aForm, aStateType, f_Children);
  SaveDocked(aForm, aStateType, f_Docked);
 end;//Assigned(aForm)
//#UC END# *550811520043_5506DC9F019D_impl*
//#UC START# *550811520043_5506DC9F019D_var*
//#UC END# *550811520043_5506DC9F019D_var*
//#UC START# *550825D501AF_5506DC9F019D_impl*
 aList := nil;
 if not Assigned(aForm.FormSet) and (aStateType = vcm_stContent) then
  l_SaveOwned(aForm.VCLWinControl);
//#UC END# *550825D501AF_5506DC9F019D_impl*
//#UC START# *550825D501AF_5506DC9F019D_var*
 procedure l_SaveOwned(aControl: TComponent);
 var
  l_Index: Integer;
  l_Child: TComponent;
  l_Form: IvcmEntityForm;
 begin//SaveOwned
  with aControl do
   for l_Index := 0 to Pred(ComponentCount) do
   begin
    l_Child := Components[l_Index];
    if (l_Child Is TCustomForm) and
       Supports(l_Child, IvcmEntityForm, l_Form) then
     try
      if (aList = nil) then
       aList := TvcmFormHistoryItemList.Make;
      aList.Add(MakeChild(l_Form, aStateType));
     finally
      l_Form := nil;
     end;//try..finally
   end;//for l_Index
 end;//l_SaveOwned
//#UC END# *550825D501AF_5506DC9F019D_var*
//#UC START# *550825EE00D2_5506DC9F019D_impl*
 aList := nil;
 if not Assigned(aForm.FormSet) and (aStateType = vcm_stContent) then
  l_SaveDocked(aForm.VCLWinControl);
//#UC END# *550825EE00D2_5506DC9F019D_impl*
//#UC START# *550825EE00D2_5506DC9F019D_var*
 procedure l_SaveDocked(aControl: TWinControl);
 var
  l_Index: Integer;
  l_Child: TControl;
  l_Form: IvcmEntityForm;
 begin//l_SaveDocked
  with aControl do
   for l_Index := 0 to Pred(ControlCount) do
   begin
    l_Child := Controls[l_Index];
    if (l_Child Is TCustomForm) and (l_Child.Owner <> aControl) and
       Supports(l_Child, IvcmEntityForm, l_Form) then
     try
      if (aList = nil) then
       aList := TvcmFormHistoryItemList.Make;
      aList.Add(MakeChild(l_Form, aStateType));
     finally
      l_Child := nil;
     end;//try..finally
    if (l_Child Is TWinControl) then
     l_SaveDocked(TWinControl(l_Child));
   end;//for l_Index
 end;//l_SaveDocked
//#UC END# *550825EE00D2_5506DC9F019D_var*
//#UC START# *5508260503CB_5506DC9F019D_impl*
 if not aInFormSet and (aList <> nil) then
  with aList do
   for l_Index := Lo to Hi do
    Items[l_Index].Activate(aMainForm, aForm);
//#UC END# *5508260503CB_5506DC9F019D_impl*
//#UC START# *5508260503CB_5506DC9F019D_var*
var
 l_Index: Integer;
//#UC END# *5508260503CB_5506DC9F019D_var*
